@model ShopNow.ViewModels.AgencyAssignListViewModel
@{
    ViewBag.Title = "Agency Assign";
}

<title>ShopNow | @ViewBag.Title</title>

<div class="container-fluid mb-3">
    <div class="row">
        <div class="col-md-12 mx-auto">
            <div class="d-flex justify-content-between my-3">
                <h5 class="text-success" style="letter-spacing:1px">@ViewBag.Title</h5>
                <a href="#modal-add-agency" data-target="#modal-add-agency" data-toggle="modal">Add New Agency</a>
            </div>
            <div class="card shadow">
                <div class="card-body">
                    <form method="get" action="/Agency/Index">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select id="AgencyId-filter" class="form-control" name="FilterAgencyId">
                                    @if (Model.FilterAgencyId != 0)
                                    {
                                        <option value="@Model.FilterAgencyId">@Model.FilterAgencyName</option>
                                    }
                                </select>
                                <input type="hidden" name="FilterAgencyName" />
                            </div>
                            <div class="col-md-4">
                                <input type="submit" class="btn btn-info mr-3" value="Filter" />
                                <a href="/Agency/Index" class="btn btn-warning">Clear</a>
                            </div>
                        </div>
                    </form>
                    <table class="table table-borderless" id="tbl-shop-schedules">
                        <thead class="bg-light">
                            <tr>
                                <th>Agency Name</th>
                                <th>Shop Name(s)</th>
                                <th>Delivery Boy Name(s)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Lists)
                            {
                            <tr>
                                <td>@item.AgencyName</td>
                                <td>
                                    @foreach (var shop in item.ShopListItems)
                                    {
                                        <div class="d-flex">
                                            <label class="mr-4">@shop.ShopName</label>
                                            <a href="/Agency/DeleteShop?id=@shop.ShopId" class="text-danger"><i class="fa fa-close fa-lg"></i></a>
                                        </div>

                                    }
                                </td>
                                <td>
                                    @foreach (var deliveryBoy in item.DeliveryBoyListItems)
                                    {
                                        <div class="d-flex">
                                            <label class="mr-4">@deliveryBoy.DeliveryBoyName</label>
                                            <a href="/Agency/DeleteDeliveryBoy?id=@deliveryBoy.DeliveryBoyId" class="text-danger"><i class="fa fa-close fa-lg"></i></a>
                                        </div>

                                    }
                                </td>
                                <td>
                                    <a href="#modal-add-timimgs" data-target="#modal-add-timimgs" data-toggle="modal" data-agencyid="@item.AgencyId" class="text-info mr-4 btn-add-timing"><i class="fa fa-plus fa-lg"></i></a>
                                    <a href="javascript:void(0)" data-agencyid="@item.AgencyId" class="text-danger btnDelete"><i class="fa fa-trash fa-lg"></i></a>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-add-agency" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header alert alert-info">
                <h5 class="modal-title">Add New Agency</h5>
                <button type="button" class="btnClose close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="col-form-label font-weight-bold text-muted">Select Agency</label>
                    <select id="AgencyId" class="form-control" name="AgencyId"></select>
                    <input type="hidden" name="AgencyName" id="AgencyName" />
                </div>
                <hr />
                <div class="row">
                    <div class="col-md-6">
                        <label class="col-form-label text-secondary font-weight-bold">DeliveryBoy Name<span class="text-danger">*</span></label>
                        <select id="DeliveryBoyIds" name="DeliveryBoyIds" class="form-control" multiple></select>
                    </div>
                    <div class="col-md-6">
                        <label class="col-form-label text-secondary font-weight-bold">Shop Name<span class="text-danger">*</span></label>
                        <select id="ShopIds" name="ShopIds" class="form-control" multiple></select>
                    </div>
                    @*<div class="col-md-2">
                        <div class="form-group">
                            <label class="col-form-label">&nbsp;</label>
                            <input type="button" class="btn btn-primary btn-block h-50" value="Add" id="btn-addTime" />
                        </div>
                    </div>*@
                </div>
                @*<div class="row d-none" id="div-times">
                    <div class="col-md-12">
                        <h6>Timing List</h6>
                        <table class="table table-bordered table-sm table-striped" id="tbl-times">
                            <thead class="bg-light font-weight-bold">
                                <tr>
                                    <td>On Time</td>
                                    <td>Off Time</td>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>*@
                <div class="mx-auto col-6 mt-5"> <input id="btn-add-agency" type="button" value="Add Agency" class="btn btn-success btn-block" /></div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modal-add-timimgs" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header alert alert-success">
                <h5 class="modal-title">Add Timings</h5>
                <button type="button" class="btnClose close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="/ShopSchedule/AddTiming" method="post">
                    <input type="hidden" name="ShopId" />
                    <div class="row">
                        <div class="col-md-5">
                            <div class="form-group">
                                <label class="col-form-label font-weight-bold text-muted">On Time</label>
                                <input type="time" name="OnTime" class="form-control" required />
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label class="col-form-label font-weight-bold text-muted">Off Time</label>
                                <input type="time" name="OffTime" class="form-control" required />
                            </div>
                        </div>
                    </div>
                    <div class="mx-auto col-8 mt-3"> <input type="submit" value="Add" class="btn btn-success btn-block" /></div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-update-timimgs" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header alert alert-info">
                <h5 class="modal-title">Update Timings</h5>
                <button type="button" class="btnClose close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="/ShopSchedule/UpdateTiming" method="post">
                    <input type="hidden" name="Id" />
                    <div class="row">
                        <div class="col-md-5">
                            <div class="form-group">
                                <label class="col-form-label font-weight-bold text-muted">On Time</label>
                                <input id="edit-onTime" type="time" name="OnTime" class="form-control" required />
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label class="col-form-label font-weight-bold text-muted">Off Time</label>
                                <input id="edit-offTime" type="time" name="OffTime" class="form-control" required />
                            </div>
                        </div>
                    </div>
                    <div class="mx-auto col-8 mt-3"> <input type="submit" value="Update" class="btn btn-warning btn-block" /></div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script src="~/Scripts/sweetalert/sweetalert.min.js"></script>
    <link href="~/Content/sweetalert/sweetalert.css" rel="stylesheet" />
    <script src="~/Scripts/select2/js/select2.js"></script>
    <link href="~/Scripts/select2/css/select2.css" rel="stylesheet" />
    <link href="~/Content/select2/select2.custom.css" rel="stylesheet" />
    <script>
        $(document).ready(function () {
           

            $('#AgencyId-filter').select2({
                placeholder: "Search Agency",
                width: '100%',
                ajax: {
                    url: "/Agency/GetAgencySelect2",
                    delay: 250,
                    dataType: 'json'
                }
            }).on('select2:select', function (e) {
                $('input[name="FilterAgencyName"]').val(e.params.data.text);
            });

            $('#AgencyId').select2({
                placeholder: "Select Agency",
                width: '100%',
                ajax: {
                    url: "/Agency/GetAgencySelect2",
                    delay: 250,
                    dataType: 'json'
                }
            }).on('select2:select', function (e) {
                $('input[name="AgencyName"]').val(e.params.data.text);
            });

            $('#ShopIds').select2({
                placeholder: "Select Shop",
                width: '100%',
                ajax: {
                    url: "/Agency/GetShopSelect2",
                    delay: 250,
                    dataType: 'json'
                }
            });

            $('#DeliveryBoyIds').select2({
                placeholder: "Select DeliveryBoy",
                width: '100%',
                ajax: {
                    url: "/Agency/GetDeliveryBoySelect2",
                    delay: 250,
                    dataType: 'json'
                }
            });

            $(".btnDelete").click(function () {
                var Id = $(this).attr('data-agencyid');
                swal({
                    title: "Are you sure want to delete?",
                    text: "You will not be able to recover this file!",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Yes, Delete it!",
                    cancelButtonText: "No, cancel",
                    closeOnConfirm: false,
                    closeOnCancel: true
                },
                    function (isConfirm) {
                        if (isConfirm) {
                            $.getJSON("/Agency/Delete", { shopId: Id }, function (data) {
                                if (data == true) {
                                    window.location.reload();
                                }
                            });
                        }
                    }
                );
            });


            //$('#btn-addTime').on('click', function () {
            //    var onTime = $('[name="OnTime"]').val();
            //    var offTime = $('[name="OffTime"]').val();
            //    if (onTime && offTime) {
            //        var times = {
            //            onTime: onTime,
            //            offTime: offTime
            //        };
            //        timeArray.push(times);
            //        var $tr = '<tr><td>' + onTime + '</td><td>' + offTime + '</td></tr>';
            //        $('#tbl-times tbody').append($tr);
            //        $('#div-times').removeClass('d-none');
            //        $('[name="OnTime"]').val('');
            //        $('[name="OffTime"]').val('');
            //    } else
            //        swal('Warning', 'Timings are required!', 'warning');
            //});

            $('#btn-add-agency').on('click', function () {
                if ($('#AgencyId').val()) {
                    if ($('#ShopIds').val()) {
                        if ($('#DeliveryBoyIds').val()) {
                            var model = {
                                AgencyId: $('#AgencyId').val(),
                                AgencyName: $('#AgencyName').val(),
                                ShopIds: $('#ShopIds').val(),
                                DeliveryBoyIds: $('#DeliveryBoyIds').val()
                            }
                            $.post('/Agency/Add', model, function (data) {
                                if (data == true) {
                                    swal('Success', 'Agency saved successfully', 'success');
                                    window.location.reload();
                                }
                                //else {
                                //    swal('Warning', 'Shop already has Schedules, Kindly update there.', 'warning');
                                //    timeArray.length = 0;
                                    //$('#tbl-times tbody').empty();
                                    //$('#div-times').addClass('d-none');
                                    //$('#select-shop').val('').trigger('change');
                                    //$('#modal-add-agency').modal('hide');
                                //}
                            });
                        } else
                            swal('Warning', 'DeliveryBoy is required!', 'warning');
                    } else
                        swal('Warning', 'Shop is required!', 'warning');
                } else
                    swal('Warning', 'Agency is required!', 'warning');
            });

            $("#tbl-shop-schedules").on('click', '.btn-edit-timing', function () {
                $('[name="Id"]').val($(this).attr('data-id'));
                $("#edit-onTime").val($(this).attr('data-ontime'));
                $("#edit-offTime").val($(this).attr('data-offtime'));
            });

            $("#tbl-shop-schedules").on('click', '.btn-add-timing', function () {
                $('[name="ShopId"]').val($(this).attr('data-shopid'));
            });

        });
    </script>
}